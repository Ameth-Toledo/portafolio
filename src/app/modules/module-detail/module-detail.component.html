<section class="module-section">
  <div *ngIf="loading" class="module-container">
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Cargando contenido del módulo...</p>
    </div>
  </div>

  <div *ngIf="error && !loading" class="module-container">
    <div class="error-state">
      <h2>Error</h2>
      <p>{{ error }}</p>
      <button class="custom-button" (click)="goBack()">
        <span class="button-inner">
          <span class="button-text">Volver a Módulos</span>
        </span>
      </button>
    </div>
  </div>

  <div *ngIf="modulo && !loading && !error" class="module-container">
    <div class="module-header">
      <div class="module-info">
        <div class="module-navigation">
          <div class="button-container">
            <button class="button" (click)="goBack()">
              <div class="button-box">
                <span class="button-elem">
                  <svg viewBox="0 0 46 40" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17c.5-.5.8-1.1.8-1.9z">
                    </path>
                  </svg>
                </span>
                <span class="button-elem">
                  <svg viewBox="0 0 46 40">
                    <path
                      d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17c.5-.5.8-1.1.8-1.9z">
                    </path>
                  </svg>
                </span>
              </div>
            </button>
          </div>

          <div class="module-title">
            <h1>{{ modulo.titulo }}</h1>
            <p class="module-description">{{ modulo.descripcion }}</p>
          </div>
        </div>
      </div>

      <div class="module-image">
        <img [src]="'icons/' + modulo.imagen_portada + '.svg'" [alt]="'Imagen del módulo ' + modulo.titulo"
          onerror="this.src='icons/default.svg'">
      </div>
    </div>

    <div class="module-content" *ngIf="modulo.video_url">
      <app-reproductor-video [videoUrl]="modulo.video_url"></app-reproductor-video>
    </div>
    
    <div class="module-content" *ngIf="!modulo.video_url">
      <div class="no-video-placeholder">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#666">
          <path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        <p>No hay video disponible para este módulo</p>
      </div>
    </div>
  </div>

  <app-card-module-description [modulo]="modulo"></app-card-module-description>

  <div *ngIf="modulo?.repositorio && !loading && !error" class="repository-section">
    <h2 class="section-title">Repositorio del módulo</h2>
    <button class="btn-repositorio" (click)="openRepository()">
      <svg class="iconsvg" fill="#ffffff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <g stroke-width="0" id="SVGRepo_bgCarrier"></g>
        <g stroke-linejoin="round" stroke-linecap="round" id="SVGRepo_tracerCarrier"></g>
        <g id="SVGRepo_iconCarrier">
          <title>github</title>
          <rect fill="none" height="24" width="24"></rect>
          <path
            d="M12,2A10,10,0,0,0,8.84,21.5c.5.08.66-.23.66-.5V19.31C6.73,19.91,6.14,18,6.14,18A2.69,2.69,0,0,0,5,16.5c-.91-.62.07-.6.07-.6a2.1,2.1,0,0,1,1.53,1,2.15,2.15,0,0,0,2.91.83,2.16,2.16,0,0,1,.63-1.34C8,16.17,5.62,15.31,5.62,11.5a3.87,3.87,0,0,1,1-2.71,3.58,3.58,0,0,1,.1-2.64s.84-.27,2.75,1a9.63,9.63,0,0,1,5,0c1.91-1.29,2.75-1,2.75-1a3.58,3.58,0,0,1,.1,2.64,3.87,3.87,0,0,1,1,2.71c0,3.82-2.34,4.66-4.57,4.91a2.39,2.39,0,0,1,.69,1.85V21c0,.27.16.59.67.5A10,10,0,0,0,12,2Z">
          </path>
        </g>
      </svg>
      Ver en GitHub
    </button>
  </div>

  <div *ngIf="modulo && !loading && !error" class="navigation-buttons">
    <div class="button-group">
      <button class="custom-button" (click)="goToPreviousModule()" [disabled]="modulo.id_modulo <= 1">
        <span class="button-gradient"></span>
        <span class="button-inner">
          <div class="button-content">
            <span class="button-text">Anterior</span>
            <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7.828 11l5.364-5.364L11.778 4.222 4 12l7.778 7.778 1.414-1.414L7.828 13H20v-2z"></path>
            </svg>
          </div>
        </span>
      </button>

      <button class="custom-button" (click)="goToNextModule()">
        <span class="button-gradient"></span>
        <span class="button-inner">
          <div class="button-content">
            <span class="button-text">Siguiente</span>
            <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"></path>
            </svg>
          </div>
        </span>
      </button>
    </div>
  </div>

  <div class="comments-section" *ngIf="modulo && !loading && !error">
    <h2 class="section-title">Comentarios</h2>

    <div class="comment-form">
      <textarea [(ngModel)]="nuevoComentario" placeholder="Escribe tu comentario..." class="comment-input"
        (keydown.space)="handleTextareaKeydown($event)"></textarea>
      <button (click)="agregarComentario()" class="comment-submit-btn" [disabled]="!nuevoComentario.trim()">
        Enviar comentario
      </button>
    </div>

    <div class="comments-list">
      <div *ngIf="cargandoComentarios" class="loading-comments">
        <div class="spinner"></div>
        <p>Cargando comentarios...</p>
      </div>

      <div *ngFor="let comentario of comentarios" class="comment-item">

        <div class="comment-actions" *ngIf="comentario.canEdit">
          <button class="action-btn edit-btn" (click)="editarComentario(comentario.key, comentario.texto)"
            *ngIf="comentario.key !== editandoComentario">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Editar
          </button>
          <button class="action-btn delete-btn" (click)="eliminarComentario(comentario.key)"
            *ngIf="comentario.key !== editandoComentario">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Eliminar
          </button>
        </div>

        <div class="comment-header">
          <div class="comment-avatar">
            <img [src]="'/avatares/' + (comentario.avatar || 1) + '.png'" [alt]="comentario.autor"
              onerror="this.src='/avatares/default-avatar.png'">
          </div>
          <div class="comment-author-info">
            <span class="comment-author">{{comentario.autor}}</span>
            <span class="comment-date">
              {{comentario.fecha | date:'mediumDate'}}
            </span>
          </div>
        </div>

        <div class="comment-content" *ngIf="comentario.key !== editandoComentario">
          {{comentario.texto}}
        </div>

        <div *ngIf="comentario.key === editandoComentario && comentario.canEdit">
          <textarea [(ngModel)]="textoEditando" class="edit-input"></textarea>
          <div class="edit-actions">
            <button class="action-btn save-btn" (click)="guardarEdicion(comentario.key)"
              [disabled]="!textoEditando.trim()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                <polyline points="7,3 7,8 15,8"></polyline>
              </svg>
              Guardar
            </button>
            <button class="action-btn cancel-btn" (click)="cancelarEdicion()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="comentarios.length === 0 && !cargandoComentarios" class="no-comments">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <p>No hay comentarios aún. ¡Sé el primero en comentar!</p>
      </div>
    </div>
  </div>
</section>

<div class="modal-final" *ngIf="showFinalModal">
  <div class="modal-final-overlay" (click)="closeFinalModal()"></div>
  <div class="modal-final-container">
    <div class="modal-final-card">
      <div class="confetti">
        <div class="confetti-piece"></div>
        <div class="confetti-piece"></div>
        <div class="confetti-piece"></div>
        <div class="confetti-piece"></div>
        <div class="confetti-piece"></div>
        <div class="confetti-piece"></div>
        <div class="confetti-piece"></div>
      </div>

      <div class="modal-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#10B981"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>

      <h2 class="modal-title">¡Fin del Tutorial!</h2>
      <p class="modal-message">Esto ha sido todo de este tutorial, espero y te haya servido mucho, saludos:
        <strong>Ameth Toledo</strong>
      </p>

      <div class="modal-actions">
        <button class="modal-button" (click)="closeFinalModal()">
          <span>Cerrar</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<app-chatbot></app-chatbot>