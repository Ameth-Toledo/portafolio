<app-header-blog (buscar)="onBuscar($event)"></app-header-blog>

<section class="welcome-section">
  <div class="welcome-container">
    <div class="nav-container">
      <button class="button" (click)="sendToHome($event)">
        <div class="button-box">
          <span class="button-elem">
            <svg viewBox="0 0 46 40" xmlns="http://www.w3.org/2000/svg">
              <path d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17c.5-.5.8-1.1.8-1.9z"></path>
            </svg>
          </span>
          <span class="button-elem">
            <svg viewBox="0 0 46 40">
              <path d="M46 20.038c0-.7-.3-1.5-.8-2.1l-16-17c-1.1-1-3.2-1.4-4.4-.3-1.2 1.1-1.2 3.3 0 4.4l11.3 11.9H3c-1.7 0-3 1.3-3 3s1.3 3 3 3h33.1l-11.3 11.9c-1 1-1.2 3.3 0 4.4 1.2 1.1 3.3.8 4.4-.3l16-17c.5-.5.8-1.1.8-1.9z"></path>
            </svg>
          </span>
        </div>
      </button>

      <h1 class="title-front">Mi Perfil</h1>
    </div>

    <p class="profile-description">
      {{ isEditing ? 'Editando información personal' : 'Gestiona tu información personal y configuración de cuenta.' }}
    </p>
  </div>
</section>

<div class="profile-container">
  <div *ngIf="isLoading" class="loading-container">
    <h2 class="profile-section">Cargando perfil...</h2>
  </div>

  <div *ngIf="error" class="error-container">
    <div class="card-alert">
      <svg viewBox="0 0 576 512" xmlns="http://www.w3.org/2000/svg">
        <path d="m569.517 440.013c18.458 31.994-4.711 71.987-41.577 71.987h-479.886c-36.937 0-59.999-40.055-41.577-71.987l239.946-416.028c18.467-32.009 64.72-31.951 83.154 0zm-281.517-86.013c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"></path>
      </svg>
      <p>{{ error }}</p>
    </div>
  </div>

  <div *ngIf="!isLoading && !error && user" class="minimal-profile-content full-width">
    <!-- Header del perfil -->
    <div class="profile-header">
      <div class="avatar-section">
        <img [src]="getAvatarPath(isEditing ? editableUser?.avatar : user.avatar)" 
             alt="Avatar" 
             class="profile-avatar-image" 
             (error)="handleImageError($event)">
        
        <!-- Selector de avatar en modo edición -->
        <div *ngIf="isEditing" class="avatar-selector">
          <label class="detail-label">Seleccionar avatar:</label>
          <div class="avatar-grid">
            <div *ngFor="let avatarId of availableAvatars" 
                 class="avatar-option" 
                 [class.selected]="editableUser?.avatar === avatarId"
                 (click)="editableUser!.avatar = avatarId">
              <img [src]="getAvatarPath(avatarId)" 
                   alt="Avatar {{avatarId}}" 
                   class="avatar-thumbnail"
                   (error)="handleImageError($event)">
            </div>
          </div>
        </div>
      </div>

      <div class="profile-info">
        <!-- Modo vista -->
        <div *ngIf="!isEditing">
          <h2 class="profile-name">{{ fullName }}</h2>
          <p class="profile-email">{{ user.email }}</p>
        </div>

        <!-- Modo edición -->
        <div *ngIf="isEditing" class="edit-form">
          <div class="form-group">
            <label class="detail-label">Nombres:</label>
            <input type="text" 
                   [(ngModel)]="editableUser!.nombres" 
                   class="form-input"
                   placeholder="Ingresa tu nombre">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="detail-label">Apellido paterno:</label>
              <input type="text" 
                     [(ngModel)]="editableUser!.apellido_paterno" 
                     class="form-input"
                     placeholder="Apellido paterno">
            </div>
            
            <div class="form-group">
              <label class="detail-label">Apellido materno:</label>
              <input type="text" 
                     [(ngModel)]="editableUser!.apellido_materno" 
                     class="form-input"
                     placeholder="Apellido materno">
            </div>
          </div>

          <div class="form-group">
            <label class="detail-label">Email:</label>
            <input type="email" 
                   [(ngModel)]="editableUser!.email" 
                   class="form-input"
                   placeholder="tu@email.com">
          </div>
        </div>
      </div>
    </div>

    <!-- Detalles del perfil -->
    <div class="profile-details">
      <div class="detail-item">
        <span class="detail-label">Miembro desde</span>
        <span class="detail-value">{{ formattedDate }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Avatar seleccionado</span>
        <span class="detail-value">#{{ isEditing ? editableUser?.avatar : user.avatar }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Rol</span>
        <span class="detail-value">{{ getRoleName(user.rol_id) }}</span>
      </div>
    </div>

    <!-- Acciones -->
    <div class="profile-actions">
      <!-- Botones en modo vista -->
      <div *ngIf="!isEditing" class="action-buttons">
        <button class="btn-edit" (click)="editProfile()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
          </svg>
          Editar perfil
        </button>
        <button class="btn-delete" (click)="confirmDeleteAccount()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
          </svg>
          Eliminar cuenta
        </button>
      </div>

      <!-- Botones en modo edición -->
      <div *ngIf="isEditing" class="action-buttons">
        <button class="btn-cancel" (click)="cancelEdit()" [disabled]="isSaving">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
          Cancelar
        </button>
        <button class="btn-save" (click)="saveProfile()" [disabled]="isSaving">
          <svg class="icon" viewBox="0 0 24 24" *ngIf="!isSaving">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          <svg class="icon spin" viewBox="0 0 24 24" *ngIf="isSaving">
            <path d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25"/>
            <path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"/>
          </svg>
          {{ isSaving ? 'Guardando...' : 'Guardar cambios' }}
        </button>
      </div>
    </div>
  </div>
</div>