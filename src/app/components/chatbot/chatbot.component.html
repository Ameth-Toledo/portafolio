<!-- Botón flotante del chatbot -->
<div class="chatbot-toggle" [class.hidden]="isOpen" (click)="toggleChat()">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M8 12H16M8 8H16M8 16H13M7 4V2.5C7 2.22386 7.22386 2 7.5 2H16.5C16.7761 2 17 2.22386 17 2.5V4M20 12C20 16.4183 16.4183 20 12 20C10.4407 20 8.99066 19.4768 7.82836 18.5836L4 20L5.41644 16.1716C4.52321 14.9093 4 13.4593 4 12C4 7.58172 7.58172 4 12 4C16.4183 4 20 7.58172 20 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>

<!-- Ventana del chatbot -->
<div class="chatbot-container" [class.open]="isOpen">
  <div class="chatbot-header">
    <div class="header-content">
      <div class="avatar">
        <img src="perfilAI2.png" alt="AmethDev" />
      </div>
      <div class="chat-info">
        <div class="chat-title">AmethDev</div>
        <div class="chat-subtitle">Asistente de IA</div>
      </div>
    </div>
    <button class="close-btn" (click)="toggleChat()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <div class="messages-container">
    <div *ngFor="let message of messages; let i = index" 
         class="message-wrapper"
         [class.user-message]="message.isUser"
         [class.bot-message]="!message.isUser">
      <div class="message-box">
        
        <!-- Contenido normal del mensaje -->
        <div class="message-content" 
             [innerHTML]="message.formattedText || message.text">
        </div>
        
        <!-- Renderizado de bloques de código si existen -->
        <ng-container *ngIf="message.hasCodeBlocks && message.codeBlocks">
          <div *ngFor="let codeBlock of message.codeBlocks" class="code-block-container">
            <div class="code-block-header">
              <span class="code-language">{{codeBlock.language}}</span>
              <button class="copy-code-btn" 
                      (click)="copyCode(codeBlock.code, codeBlock.id)"
                      [attr.data-code-id]="codeBlock.id">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 4V2C8 1.44772 8.44772 1 9 1H19C19.5523 1 20 1.44772 20 2V12C20 12.5523 19.5523 13 19 13H17V11H18V3H10V4H8Z" fill="currentColor"/>
                  <path d="M5 5C4.44772 5 4 5.44772 4 6V20C4 20.5523 4.44772 21 5 21H15C15.5523 21 16 20.5523 16 20V6C16 5.44772 15.5523 5 15 5H5Z" fill="currentColor"/>
                </svg>
                Copiar
              </button>
            </div>
            <div class="code-block-content">
              <pre class="code-block-pre">{{codeBlock.code}}</pre>
            </div>
          </div>
        </ng-container>
        
        <span class="timestamp">{{ message.timestamp | date:'HH:mm' }}</span>
      </div>
    </div>
    
    <!-- Indicador de carga -->
    <div *ngIf="isLoading" class="message-wrapper bot-message">
      <div class="message-box loading-message">
        <div class="typing-animation">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span class="loading-text">AmethDev está escribiendo...</span>
      </div>
    </div>
  </div>

  <div class="input-container">
    <form (ngSubmit)="sendMessage()">
      <textarea 
        [(ngModel)]="newMessage"
        name="chatMessage"
        (keypress)="onKeyPress($event)"
        placeholder="Pregúntame sobre programación..."
        class="message-input"
        [disabled]="isLoading"
        rows="1"
        maxlength="500"></textarea>
      <button type="submit" class="send-btn" [disabled]="!newMessage.trim() || isLoading">
        <svg *ngIf="!isLoading" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div *ngIf="isLoading" class="loading-spinner"></div>
      </button>
    </form>
  </div>
</div>

<!-- Script mejorado para manejar código con tema verde -->
<script>
  // Sistema mejorado de copia de código
  function copyCodeBlock(code, buttonElement) {
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(code).then(() => {
        console.log('Código copiado al portapapeles');
        showCopySuccess(buttonElement);
      }).catch(err => {
        console.error('Error al copiar código:', err);
        fallbackCopyText(code, buttonElement);
      });
    } else {
      fallbackCopyText(code, buttonElement);
    }
  }

  // Feedback visual mejorado para copia
  function showCopySuccess(buttonElement) {
    if (buttonElement) {
      const originalHTML = buttonElement.innerHTML;
      const originalBg = buttonElement.style.background;
      
      buttonElement.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 6L9 17l-5-5"></path>
        </svg>
        ¡Copiado!
      `;
      buttonElement.style.background = '#15803D';
      buttonElement.style.borderColor = '#166534';
      buttonElement.classList.add('copied');
      
      setTimeout(() => {
        buttonElement.innerHTML = originalHTML;
        buttonElement.style.background = originalBg;
        buttonElement.style.borderColor = 'rgba(255, 255, 255, 0.3)';
        buttonElement.classList.remove('copied');
      }, 2000);
    }
  }

  // Función fallback para navegadores antiguos
  function fallbackCopyText(text, buttonElement) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      console.log('Código copiado al portapapeles (fallback)');
      showCopySuccess(buttonElement);
    } catch (err) {
      console.error('Error al copiar código:', err);
    }
    
    document.body.removeChild(textArea);
  }

  // Observer mejorado para manejar contenido dinámico
  document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length > 0) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) {
              // Procesar placeholders de código
              const placeholders = node.querySelectorAll ? 
                node.querySelectorAll('.code-block-placeholder') : [];
              
              placeholders.forEach(function(placeholder) {
                const language = placeholder.getAttribute('data-language') || 'javascript';
                const codeId = placeholder.id;
                
                // Buscar el código correspondiente en el componente
                const codeText = window.getCodeById ? window.getCodeById(codeId) : '';
                
                if (codeText) {
                  const codeHtml = `
                    <div class="code-block-container">
                      <div class="code-block-header">
                        <span class="code-language">${language}</span>
                        <button class="copy-code-btn" onclick="copyCodeBlock('${codeText.replace(/'/g, "\\'")}', this)">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 4V2C8 1.44772 8.44772 1 9 1H19C19.5523 1 20 1.44772 20 2V12C20 12.5523 19.5523 13 19 13H17V11H18V3H10V4H8Z" fill="currentColor"/>
                            <path d="M5 5C4.44772 5 4 5.44772 4 6V20C4 20.5523 4.44772 21 5 21H15C15.5523 21 16 20.5523 16 20V6C16 5.44772 15.5523 5 15 5H5Z" fill="currentColor"/>
                          </svg>
                          Copiar
                        </button>
                      </div>
                      <div class="code-block-content">
                        <pre class="code-block-pre">${codeText}</pre>
                      </div>
                    </div>
                  `;
                  placeholder.outerHTML = codeHtml;
                }
              });

              // Asegurar que todos los elementos de código no escapen
              const codeElements = node.querySelectorAll ? 
                node.querySelectorAll('.code-content, .code-block-pre, pre, code') : [];
              
              codeElements.forEach(function(element) {
                element.style.maxWidth = '100%';
                element.style.overflowX = 'auto';
                element.style.boxSizing = 'border-box';
                element.style.wordWrap = 'normal';
              });

              // Aplicar estilos a contenedores de código
              const codeContainers = node.querySelectorAll ? 
                node.querySelectorAll('.code-block, .code-block-container') : [];
              
              codeContainers.forEach(function(container) {
                container.style.width = '100%';
                container.style.maxWidth = '100%';
                container.style.overflow = 'hidden';
                container.style.boxSizing = 'border-box';
              });
            }
          });
        }
      });
    });

    // Observar el contenedor de mensajes
    const messagesContainer = document.querySelector('.messages-container');
    if (messagesContainer) {
      observer.observe(messagesContainer, {
        childList: true,
        subtree: true
      });
    }

    // Procesar elementos existentes
    const existingCodeBlocks = document.querySelectorAll('.code-content, .code-block-pre, pre, code');
    existingCodeBlocks.forEach(function(element) {
      element.style.maxWidth = '100%';
      element.style.overflowX = 'auto';
      element.style.boxSizing = 'border-box';
    });
  });

  // Función global para obtener código por ID (se conecta con Angular)
  window.getCodeById = function(codeId) {
    // Esta función será sobrescrita por el componente Angular
    return '';
  };

  // Función mejorada para copiar código
  window.copyCodeBlock = function(code, buttonElement) {
    copyCodeBlock(code, buttonElement);
  };
</script>